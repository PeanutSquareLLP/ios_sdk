# SparkSDK

## Description

Spark SDK enables native support of Spark video features in your iOS apps.

## Installation
- Using [CocoaPods](https://cocoapods.org):
Add the following line to your Podfile:
```
pod 'HolaSpark', '~> 0.0'
```

- Manual installation:

-- Copy **libspark_sdk.a** and **spark_api.h** to your project's folder, e.g.:
```
<myapproot>
  <myapp>
  <myapp>.xcodeproj
  spark_sdk
    libspark_sdk.a
    spark_api.h
```
-- Add the new folder to XCode project\
-- Open your app configuration settings\
-- Switch to "Build Phases" > "Link Binary With Libraries" > "+" > "Add other"\
-- Select libspark_sdk.a

## Usage

Initialize Spark SDK with your customer id:
```objc
// Objective-C example
- (BOOL) application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)options
{
    SparkAPI *api = [SparkAPI getSparkAPI:@"<customer_id>"];
    ...
}
```
```swift
// Swift example
func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey: Any]?) -> Bool
{
    let api = SparkAPI.getSparkAPI("<customer_id>")
    ...
}
```

NOTE: providing customer id is required only for the first provisioning call, in all subsequent calls from all around your project you can omit it and call without it:
```objc
// Objective-C example
- (IBAction)onSomeButtonClicked:(UIButton *)sender
{
    SparkAPI *api = [SparkAPI getSparkAPI:nil];
    ...
}
```
```objc
// Swift example
@IBAction func onSomeButtonClicked(sender: UIButton){
{
    let api = SparkAPI.getSparkAPI(nil);
    ...
}
```

### Video Preview Notifications

Send rich notifications with video previews. Both local and remote notifications are supported.

**1. Register your app within Notification Center**

You can add this code to didFinishLaunchingWithOptions method of UIAppDelegate protocol implementation.

```objc
// Objective-C example
[api registerForNotifications:
    UNAuthorizationOptionAlert|UNAuthorizationOptionSound
    usingRemoteNotifications:YES
    withCompletionBlock:^(NSError *error){
        if (error)
            NSLog(@"registering for notifications failed: error=%@", error);
    }];
```
```swift
// Swift example
api.register(forNotifications: [.alert, .sound], usingRemoteNotifications: true) { (error) in
     print("notification registration result:", error != nil ? error! : "success")
}
```

**2. Implement didRegisterForRemoteNotificationsWithDeviceToken delegate method (remote notifications only)**
```objc
// Objective-C example
- (BOOL) application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken
{
    // provide your remote notification server with deviceToken to communicate to this app
}
```
```swift
// Swift example
func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
    // provide your remote notification server with deviceToken to communicate to this app
}
```

**3. Send local notifications**

Spark will automatically download a preview for your video from our servers and attach it to the notification payload.
```objc
// Objective-C example
[api sendPreviewNotification: [NSURL URLWithString:@"https://yourcdn.com/path_to_video/video.m3u8"]
    withTitle:@"Watch!" withSubtitle:nil
    withBody:@"Dani Alves gets kicked out after shouting at referee in PSG defeat at Lyon"
    withTrigger:[UNTimeIntervalNotificationTrigger triggerWithTimeInterval:10 repeats:false]
    withBeforeSendBlock:^(UNMutableNotificationContent *content){
        // use this block to customize the notification payload before sending it out to the notification center
        content.sound = [UNNotificationSound soundNamed:@"custom_sound.aiff"];
    }
    withCompletionBlock:^(NSError *error){
        if (error)
            NSLog(@"local notification failed, error=%@", error);
    }];
```
```swift
// Swift example
api.sendPreviewNotification(URL(string: "https://yourcdn.com/path_to_video/video.m3u8"),
    withTitle: "Watch", withSubtitle: nil, withBody: "Body",
    withTriggerOn: UNTimeIntervalNotificationTrigger(timeInterval: 10, repeats: false),
    withBeforeSend: { (content) -> Bool in
        // use this block to customize the notification payload before sending it out to the notification center
        content!.sound = UNNotificationSound(named: "custom_sound.aiff")
        return true
    },
    withCompletionBlock: { (error) in
        if (error)
            print(@"local notification failed, error=", error!);
    })
```

**4. Send remote notifications**

You need to setup remote notification server and configure it with deviceToken generated by your app in step 2.
Here is an example of JSON payload to be generated by your server:
```json
{
    "aps": {
        "alert": {
            "title": "Watch",
            "body": "Dani Alves gets kicked out after shouting at referee in PSG defeat at Lyon" 
        },
        "category": "spark-preview",
        "mutable-content": 1  
    },
    "spark-media-url": "<video url>",
    "spark-customer-id": "<customer id>"
}
```

And this is how it can be constructed using [node-apn](https://github.com/node-apn/node-apn) project:
```js
var note = new apn.Notification();
note.expiry = Math.floor(Date.now() / 1000) + 3600; // expires 1 hour from now
note.category = "spark-preview";
note.alert = {
    title: "Watch",
    body: "Dani Alves gets kicked out after shouting at referee in PSG defeat at Lyon",
};
note.payload = {"spark-media-url": "<video url>", "spark-customer-id": "<customer id>"};
note.topic = "<your-app-bundle-id>";
note.mutableContent = 1;
apnProvider.send(notification, deviceToken).then(function(result) {
    console.log(result);
});
```

Note, by default you cannot add attachments in remote notifications, so in order to achieve the same behavior you need to create NotificationServiceExtension in your app that will download (using spark-media-url and spark-customer-id data in the payload) corresponding preview and attach it to the notification before it is displayed to the user.

Follow these steps to add NotificationServiceExtension to your project:
- From XCode: File > New > Target > iOS Tab > Notification Service Extension > Next
- Fill up extension details (product name, organization etc) and click on "Finish" button: XCode will add a new folder to your project with NotificationService class and extension's Info.plist
- Inherit NotificationService class from Spark (replace original contents of the files):
```objc
// Objective-C example

// NotificationService.h
#import "spark_api.h"
@interface NotificationService: SparkPreviewNotificationService
@end

// NotificationService.m
#import "NotificationService.h"
@implementation NotificationService
@end
```
```swift
// Swift example
TODO
```
- Link NotificationServiceExtension target against Spark library\
Using CocoaPods:\
-- Rebuild your cocoa workspace so Spark library will link with all targets automatically\
Manually:\
-- Go to "Build Phases" of your NotificationServiceExtension target settings\
-- Open up "Link Binary With Libraries" section\
-- Add Spark library

**5. Customize notification preview with autoplay/looping (better UX)**

By default, when notification center presents a notification with a media attachment, user must click on "Play" button to view the video. For better UX, we recommend registering a custom view that will autoplay/loop the preview video. Spark SDK provides a class to handle it which needs to be integrated in NotificationContentExtension of your app.

Follow these steps to add NotificationContentExtension to your project:

- From XCode: File > New > Target > iOS Tab > Notification Content Extension > Next

- Fill up extension details (product name, organization etc) and click on "Finish" button\
XCode will add a new folder to your project with NotificationViewController class, MainInterface.storyboard and Info.plist

- Inherit NotificationViewController class from Spark (replace original contents of the files):
```objc
// Objective-C example

// NotificationViewController.h
#import "spark_api.h"
@interface NotificationViewController: SparkPreviewNotificationViewController
@end

// NotificationViewController.m
#import "NotificationViewController.h"
@implementation NotificationViewController
@end
```
```swift
// Swift example
TODO
```

- Configure your extension properties with corresponding category (it is basically a route that defines which notifications to apply it to) and original content size ratio (notification size gets resized automatically based on video ratio, but we assume 16:9 to avoid redundant transformation on initial show).
Goto Info.plist > NSExtension > NSExtensionAttributes and change its attributes according to:\
-- UNNotificationExtensionCategory = "spark-preview"\
-- UNNotificationExtensionInitialContentSizeRadio = 0.5625

- Link NotificationContentExtension target against Spark library\
Using CocoaPods:\
-- Rebuild your cocoa workspace so Spark library will link with all targets automatically\
Manually:\
-- Go to "Build Phases" of your NotificationContentExtension target settings\
-- Open up "Link Binary With Libraries" section\
-- Add Spark library

### More features
Coming up soon..
